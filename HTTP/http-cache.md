# HTTP 缓存

## 缓存分类

- 私有缓存 / 浏览器缓存
- 共享缓存 / 代理缓存

### 浏览器缓存

缓存只用于单个用户，存储位置位于用户的浏览器

### 代理缓存

缓存可以被多个用户使用，储存位置位于 ISP 或者或所在地区（如公司）架设的 web 代理，这样，通过这个 web 代理访问网络的用户可以共享代理服务器上的缓存

## 常见缓存案例

一般 HTTP 缓存都是针对 GET 请求，对于其他请求缓存并没有什么大作用

- 状态码为 200 的成功 GET 请求，请求内容如 HTML 文档，图片
- 永久重定向，状态码 301
- 错误响应，状态码 404
- 不完全响应，状态码 206
- 已被定义的 cache 键名的响应

## 缓存控制

- 使用 `cache-control` 头
- 使用 `pragma` 头

### 使用 Cache-control 头

- HTTP/1.1 定义
- 请求头，响应头都支持

#### 禁止缓存

不存储客户端请求与服务端响应的内容

```
cache-control: no-store
cache-control: no-cache, no-store, must-revalidate
```

- `no-cache` 请求相关，强制将请求交给原始服务器
    - 但会将缓存验证字段带到服务端，服务端验证缓存是否过期，若未过期，返回状态码 304, 那么，会继续使用缓存
- `no-store` 缓存存储相关，不缓存
- `must-revalidate` 验证相关，必须验证缓存状态，过期的抛弃

#### 指定私有缓存/共享缓存

```
cache-control: private
//
cache-control: public
```

- `public` 响应可以被任何中间人（中间代理，CDN）进行缓存
- `private` 中间人不能缓存响应，响应只能在浏览器中进行缓存

#### 过期机制

```
cache-control: max-age=31536000
```

- 指令为 `max-age=<seconds>` 单位为秒
- `max-age` 的计算方式为距离请求发起的时间秒数，通常会用于图片，css, js 资源

> 还有另外一个 `Expires`, 它是用来指定缓存过期的某个时间点

### 使用 Pragma 头

现在应该都不用了，用的话是用来兼容基于 HTTP/1.0 的客户端

---

## 缓存驱逐

当资源被缓存后，一般情况下是永久存储在缓存中，但由于缓存空间有限，因此会定期清理缓存，这个过程为缓存驱逐

### 浏览器如何驱逐缓存

- 服务端与客户端约定一个过期时间，过期时间前的资源定义为新鲜，过期时间后的资源定义为陈旧
- 但客户端并不会自发地去清除陈旧资源

驱逐过程

1. 客户端发起请求，缓存检索到了一个对应的资源
- 若缓存资源未到过期时间，则直接使用缓存
- 若缓存资源已过过期时间，则在请求中附加一个 `If-None-Match` 头，请求发送到服务器，让服务器判断缓存资源是否还新鲜（缓存还可不可以继续使用）
- 当缓存资源还新鲜，服务端返回 304(Not Modified)，同时响应体不会带有实体信息，客户端中对应的陈旧资源又变成了新鲜资源
- 当缓存资源陈旧，则服务端响应带有实体信息，同时，客户端使用新鲜资源替换陈旧资源

### 客户端如何计算过期时间

下面序号具有优先级

1. 通过 `cache-control: max-age=N` 中的 N 来判断
2. 查看 `Expires` 属性，比较 `Expires` 值与头部中 `Date` 属性
3. 查看 `Last-Modified` 属性，通过规范文档中的公式计算得出过期时间

## 缓存校验

- 强校验器
- 弱校验器

### 强校验器

ETag

- 响应头的值，该值对 User Agent 不透明，即 User Agent 不需要知道 ETag 的值是多少，只需要使用即可
- 当资源请求响应中含有 ETag 值时，则可以在随后的请求中带上 ETag, 使用 `If-None-Match` 头进行验证

### 弱校验器

`Last-Modified`

- 弱的原因：时间范围只能精确到秒
- 配合 `If-Modified-Since` 头进行验证

---

当客户端发起缓存校验后

- 当返回正常结果，即返回整个内容时，状态码为 200
- 当浏览器可以继续使用本地缓存文件或需要浏览器更新缓存文件过期时间时，返回 304, 此时，服务端并不会返回实际内容

## References

- [HTTP 缓存](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching_FAQ)

